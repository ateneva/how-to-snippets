
## check user active sessions

All rows in **STV_SESSIONS**, including rows generated by other users, are visible to all users.

```sql
SELECT
  starttime,
  process,         --process ID for the session
  user_name,
  db_name,
  timeout_sec      --the max time in seconds a session remains inactive
FROM STV_SESSIONS
WHERE user_name LIKE '%angelina.teneva%'
```
https://docs.aws.amazon.com/redshift/latest/dg/r_STV_SESSIONS.html

## check active/recent queries
* **STV_RECENTS** is visible to all users.
  * Superusers can see all rows; regular users can see only their own data.
```sql
SELECT
 pid,
 user_name,
 starttime,
 query,
 query,
 status
FROM stv_recents
WHERE status ='Running'
```
https://docs.aws.amazon.com/redshift/latest/dg/r_STV_RECENTS.html

## check DB locks
* Redshift locks tables to prevent two users from updating the same table at the same time.

* Use the **STV_LOCKS** table to view any current updates on tables in the database.

```sql
SELECT
  table_id,
  lock_owner             --transaction ID asssociated with the lock
  lock_owner_pid         --process ID associated with teh lock
  lock_owner_start_ts,
  lock_owner_end_ts
FROM stv_locks;
```

```sql
SELECT *
FROM stv_locks
WHERE lock_owner_pid IN (
  SELECT
    process
  FROM
    stv_sessions
  WHERE 1=1
    AND user_name LIKE '%angelina.teneva%'
                        )
```

* **STV_LOCKS** is visible only to superusers. For more information
https://docs.aws.amazon.com/redshift/latest/dg/r_STV_LOCKS.html

## kill query
```sql
SELECT 
  pg_terminate_backend(pid);
```


## check if tables have been queried recently
```sql
WITH tbles AS (
  SELECT DISTINCT
    oid,
    relname
  FROM
    pg_class c
  WHERE
      relowner > 1
  AND relkind = 'r'
  AND relname IN ('budget', 'visit_log')
     )

SELECT tbl,
       MAX(endtime) last_scan,
       Nvl(COUNT(DISTINCT query || LPAD(segment,3,'0')),0) num_scans
FROM stl_scan s
WHERE 1=1
  AND s.userid > 1
  AND   s.tbl IN (SELECT oid FROM tbles)
GROUP BY tbl
```

### identify Redshift users and their user groups
```bash
SELECT
  usename AS user_name,
  groname AS user_group
FROM
  pg_user,
  pg_group
WHERE pg_user.usesysid = ANY (pg_group.grolist
                             )
AND   pg_user.usename LIKE '%angelina%';
```
